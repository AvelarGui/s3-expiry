<html>
  <head>
    <title>Amazon S3 Expiry</title>
    <script src="http://crypto-js.googlecode.com/svn/tags/3.1.2/build/rollups/hmac-sha256.js"></script>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script>
      $(function() {
        var parsedURL = function(url) {
          var url_split = url.split(/\/+/);
          return {
            "original": url,
            "protocol": url_split[0] + "//",
            "domain": url_split[1],
            "path": "/" + (url_split.length >= 3 ? url_split.slice(2) : []).join("/")
          }
        };

        var urlSigningParams = function(access, expiration, region, iso8601, shortDate) {
          var params = '';
          params += "X-Amz-Algorithm=AWS4-HMAC-SHA256&";
          params += "X-Amz-Credential=" + access + "%2F" + shortDate + "%2F" + region + "%2Fs3%2Faws4_request&";
          params += "X-Amz-Date=" + iso8601 + "&";
          params += "X-Amz-Expires=" + expiration + "&";
          params += "X-Amz-SignedHeaders=host"
          return params;
        };

        var canonicalRequest = function(parsed, params) {
          var request = "GET\n";
          request += parsed.path + "\n";
          request += params + "\n";
          request += "host:" + parsed.domain  + "\n\n";
          request += "host\n";
          request += "UNSIGNED-PAYLOAD";

          return request;
        };

        var stringToSign = function(iso8601, shortDate, canonicalReq) {
          var str = "AWS4-HMAC-SHA256\n";
          str += iso8601 + "\n";
          str += shortDate + "/us-east-1/s3/aws4_request\n";
          str += CryptoJS.SHA256(canonicalReq).toString();
          return str;
        };

        var hmacSHA256 = function(a, b) {
          // AWS Docs pass the secret first, we swap it to be compatible
          return CryptoJS.HmacSHA256(b, a);
        };

        var signingKey = function(secret, shortDate, region) {
          return hmacSHA256(hmacSHA256(hmacSHA256(hmacSHA256("AWS4" + secret, shortDate), region), "s3"), "aws4_request");
        };

        var signedURL = function(url, requestParamStr, signature) {
          var signedURLStr = url + "?";
          signedURLStr += requestParamStr;
          signedURLStr += '&X-Amz-Signature=' + signature;
          return signedURLStr;
        };

        $('#expiry').on('submit', function(e){
          e.preventDefault();
          var target = $(e.target);
          var url = target.children('[name=url]').val();
          var access = target.children('[name=access_key]').val();
          var secret = target.children('[name=secret_key]').val();
          var expiration = target.children('[name=expiration]').val();
          var region = target.children('[name=region]').val();
          var date = new Date();
          var iso8601 = date.toISOString().replace(/\-|:|\.\d+/g, '');
          var shortDate = iso8601.replace(/T.*/, '');

          var parsedURLArr = parsedURL(url);
          var requestParamStr = urlSigningParams(access, expiration, region, iso8601, shortDate);
          var canonicalReq = canonicalRequest(parsedURLArr, requestParamStr);
          console.log("Canonical: ", canonicalReq);
          var stringToSignVar = stringToSign(iso8601, shortDate, canonicalReq);
          console.log("SigningStr: ", stringToSignVar);
          var signingKeyVar = signingKey(secret, shortDate, region);
          console.log("SigningKey: ", signingKeyVar.toString());
          var signature = hmacSHA256(signingKeyVar, stringToSignVar).toString();
          console.log("Signature: ", signature);
          var signedURLStr = signedURL(url, requestParamStr, signature);
          console.log("URL: ", signedURLStr);
          $('body').append($('<a>').attr('href', signedURLStr).text(signedURLStr))
        });
      });
    </script>
  </head>
  <body>
    <form id="expiry">
      URL: <input type='text' name='url' size="60" value='https://s3.amazonaws.com/expiry-test/foo.txt'><br>
      AccessKey: <input type='text' name='access_key' size="60" value='AKIAIPPIQEPELJQRXYKQ'><br>
      SecretKey: <input type='text' name='secret_key' size="60" value='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'><br>
      Expiration: <input type='text' name='expiration' size="60" value='300'><br>
      Region: <input type='text' name='region' size="60" value='us-east-1'><br>
      <input type='submit'>
    </form>
  </body>
</html>


